<div id="results">
	<form id="step1">
		<h5>ENTER YOUR EMAIL</h5>
		<p><small>Please verify your identity to continue.</small></p>
		<div class="row">
			<div class="eight columns">
				<input class="u-full-width" type="email" placeholder="me@mailbox.com" id="getEmail" value="aug2uag@gmail.com">
			</div>
			<div class="four columns">
				<a class="button button-primary" href="javascript:void(0)" onclick="getEmail()">Ok</a>
			</div>
		</div>
		<a class="button hidden" href="#error" id="clickSystemError"></a>
		<a class="button hidden" href="#" id="resetError"></a>
	</form>
	<form id="step2" hidden>
		<h5>VERIFY PIN</h5>
		<p><small>An email was sent to you that has the PIN.</small></p>
		<div class="row">
			<div class="digits__container">
				<p>Enter your pin</p>
				<div class="digits">
					<input type="text" class="digipin" id="digit-1" tabindex="1" data-id="1" />
					<input type="text" class="digipin" id="digit-2" tabindex="2" data-id="2" />
					<input type="text" class="digipin" id="digit-3" tabindex="3" data-id="3" />
					<input type="text" class="digipin" id="digit-4" tabindex="4" data-id="4" />
				</div>
			</div>
		</div>
	</form>
	<!-- <div class="row">
		<a class="button button-primary" href="javascript:void(0)" onclick="downloadMessengerJSON()">DOWNLOAD</a>
		<a class="button" href="#popup">Let me Pop up</a>
	</div> -->
	<div id="error" class="overlay">
		<div class="popup">
			<h2>Sorry!</h2>
			<a class="close" href="#">&times;</a>
			<div class="content">
				<span id="errorMessage"></span>
			</div>
		</div>
	</div>
	<div id="popup" class="overlay">
		<div class="popup">
			<h2>Here i am</h2>
			<a class="close" href="#">&times;</a>
			<div class="content">
				Thank to pop me out of that button, but now i'm done so you can close this window.
			</div>
		</div>
	</div>
	<script type="text/javascript">
		$('#resetError').click()
		let o = {}
		let defaultError = 'There was an error on our end, please try again at a later time.'
		function getEmail() {
			o.email = $('#getEmail').val()
			$('#getEmail').val('')
			makeRequestWithHeaders('/email', o, function(response) {
				try {
					if (response.status===200) {
						$('#step1').hide()
						$('#step2').show()
					} else {
						let message = response.message ? response.message : defaultError
						$('#errorMessage').text(message)
						$('#clickSystemError').click()
					}
				} catch(e) {
					$('#errorMessage').text(defaultError)
					$('#clickSystemError').click()
				}
			})

		}

		function verifyPIN() {
			let d1 = $('#digit-1').val()
			$('#digit-1').val('')
			let d2 = $('#digit-2').val()
			$('#digit-2').val('')
			let d3 = $('#digit-3').val()
			$('#digit-3').val('')
			let d4 = $('#digit-4').val()
			$('#digit-4').val('')
			o.pin = d1 + d2 + d3 + d4
			makeRequestWithHeaders('/verify', o, function(response) {
				try {
					if (response.status===200) {
						// show options - deploy or get code
						console.log(response)
					} else {
						let message = response.message ? response.message : defaultError
						$('#errorMessage').text(message)
						$('#clickSystemError').click()
					}
				} catch(e) {
					$('#errorMessage').text(defaultError)
					$('#clickSystemError').click()
				}
			})
		}

		function setOnscreenJSON() {
			$('#json').text(JSON.stringify(window.finalJSON, null, 4))
		}

		function downloadMessengerJSON(){
			var data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.finalJSON, null, 4))
			var downloadAnchorNode = document.createElement('a')
			downloadAnchorNode.setAttribute('href', data)
			downloadAnchorNode.setAttribute('download', 'messenger.json')
			document.body.appendChild(downloadAnchorNode)
			downloadAnchorNode.click()
			downloadAnchorNode.remove()
		}
	</script>

	<script type="text/javascript">
		var enableAutoSubmit = true

		document.querySelectorAll('.digipin').forEach(ele => {
		  ele.addEventListener('keyup', e => {
		    if ([16].indexOf(e.keyCode) >= 0) return
		    if ([37,39].indexOf(e.keyCode) < 0) {
		      
		      if (e.target.value.length === 1) {
		        let nextId = +e.target.dataset.id + 1
		        if (document.querySelector('#digit-' + nextId)) {
		          document.querySelector('#digit-' + nextId).focus()   
		        }
		      }

		      let ok = true
		      document.querySelectorAll('.digipin').forEach(ele => {
		        if (ele.value === '') {
		          ok = false
		        }
		      })

		      if (ok && enableAutoSubmit) {
		        verifyPIN()
		      }
		    }
		  })
		  ele.addEventListener('focus', e => {
		    let currentId = +e.target.dataset.id
		    
		    let moveTo = null
		    for(let i = (currentId - 1); i > 0; i--) {
		      if (document.querySelector('#digit-' + i)) {
		        if (document.querySelector('#digit-' + i).value === '') {
		           moveTo = i
		        }
		      }
		    }
		    if (moveTo) {
		      document.querySelector('#digit-' + moveTo).focus()  
		    }
		  })
		})

		window.addEventListener('keydown', e => {
		  if ([16].indexOf(e.keyCode) >= 0) return
		  if (e.keyCode === 8) {
		    e.preventDefault()
		    if (e.target.value !== '') {
		      e.target.value = '';
		    } else {
		      let prevId = +e.target.dataset.id - 1
		      if (document.querySelector('#digit-' + prevId)) {
		        document.querySelector('#digit-' + prevId).value = ''
		        document.querySelector('#digit-' + prevId).focus()
		      }
		    }
		  } else if (e.keyCode === 37 && !e.shiftKey) {
		    let id = +e.target.dataset.id - 1
		    if (document.querySelector('#digit-' + id)) {
		      let val = +document.querySelector('#digit-' + id).value
		      document.querySelector('#digit-' + id).focus()
		    }
		  } else if (e.keyCode === 39 && !e.shiftKey) {
		    let id = +e.target.dataset.id + 1
		    if (document.querySelector('#digit-' + id)) {
		      document.querySelector('#digit-' + id).focus()
		    }
		  }
		})
	</script>
</div>